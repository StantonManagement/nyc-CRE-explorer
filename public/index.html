<!DOCTYPE html>
<html>
<head>
  <title>NYC CRE Explorer - Rebuild</title>
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: #1a1a1a; 
      color: #fff; 
      padding: 20px;
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h1 { margin-bottom: 20px; flex: 0 0 auto; }
    
    /* Verification Stats */
    .stats { 
      display: flex; 
      gap: 32px; 
      font-size: 14px; 
      margin-bottom: 20px;
      padding: 12px;
      background: #2a2a2a;
      border-radius: 8px;
      flex: 0 0 auto;
    }
    .stat-value { font-size: 24px; font-weight: bold; color: #3b82f6; }
    .stat-label { font-size: 11px; color: #888; text-transform: uppercase; }
    
    /* Layout */
    .container { 
      display: flex; 
      gap: 20px; 
      flex: 1;
      min-height: 0;
    }
    
    /* Sidebar */
    .sidebar {
      width: 400px;
      display: flex;
      flex-direction: column;
      background: #222;
      border-radius: 8px;
      overflow: hidden;
      flex: 0 0 400px;
    }
    
    /* Filters */
    .filters { 
      padding: 12px; 
      border-bottom: 1px solid #444; 
      background: #2a2a2a; 
    }
    .filter-row { margin-bottom: 12px; }
    .filter-row:last-child { margin-bottom: 0; }
    .filter-label { 
      font-size: 11px; 
      color: #888; 
      text-transform: uppercase; 
      margin-bottom: 6px; 
      display: block; 
      font-weight: 600;
    }
    
    .btn-group { display: flex; gap: 4px; }
    .filter-btn { 
      flex: 1; 
      padding: 6px; 
      background: #333; 
      border: 1px solid #444; 
      color: #aaa; 
      font-size: 11px; 
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover { background: #444; }
    .filter-btn.active { 
      background: #3b82f6; 
      color: white; 
      border-color: #3b82f6; 
    }
    
    .filter-select {
      width: 100%;
      padding: 8px;
      background: #333;
      border: 1px solid #444;
      color: white;
      border-radius: 4px;
      font-size: 13px;
    }
    
    /* List */
    .list-header {
      padding: 12px;
      background: #333;
      font-weight: 600;
      border-bottom: 1px solid #444;
      border-top: 1px solid #444;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }
    
    .list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .card { 
      background: #2a2a2a; 
      padding: 12px; 
      margin-bottom: 8px; 
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .card:hover { background: #3a3a3a; border-color: #444; }
    .card.active { border-color: #3b82f6; background: #1e293b; }
    .card-address { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .card-meta { font-size: 12px; color: #888; display: flex; gap: 8px; }
    .tag { background: #333; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
    
    /* Pagination */
    .pagination {
      padding: 12px;
      background: #333;
      border-top: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    .page-btn {
      background: #444;
      border: none;
      color: white;
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-btn:hover:not(:disabled) { background: #555; }
    
    /* Map Area */
    .main-content {
      flex: 1;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #222;
    }
    
    #map { width: 100%; height: 100%; }
    
    /* Floating Detail Panel */
    .detail-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 360px;
      max-height: calc(100% - 40px);
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 0;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: none;
      z-index: 10;
    }
    
    .detail-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
    }
    .detail-section:last-child { border-bottom: none; margin-bottom: 0; }
    .section-title { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 8px; }
    
    .sales-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px dotted #333;
    }
    .sales-price { color: #4ade80; font-weight: 600; }
    .sales-date { color: #aaa; }
    
    .link-btn {
      display: block;
      width: 100%;
      padding: 8px;
      background: #333;
      color: #ddd;
      text-align: center;
      text-decoration: none;
      font-size: 12px;
      border-radius: 4px;
      margin-bottom: 8px;
      transition: background 0.2s;
    }
    .link-btn:hover { background: #444; color: white; }
    
    /* ... existing styles ... */
    
    .detail-header {
      padding: 16px;
      border-bottom: 1px solid #333;
      background: #222;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 20px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }
    .close-btn:hover { color: white; }
    
    .detail-content { padding: 16px; }
    
    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .metric-box {
      background: #2a2a2a;
      padding: 10px;
      border-radius: 4px;
    }
    .metric-label { font-size: 10px; color: #888; text-transform: uppercase; }
    .metric-value { font-size: 14px; font-weight: 600; margin-top: 2px; }
    
    /* Markers */
    .marker {
      width: 12px;
      height: 12px;
      background: #3b82f6;
      border-radius: 50%;
      border: 2px solid white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .marker:hover { transform: scale(1.2); }
    .marker.selected { 
      width: 16px; 
      height: 16px; 
      background: #f59e0b; 
      border-color: white;
      z-index: 10;
    }
    
    /* ===== Comparable Sales Section ===== */
    .comps-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color, #333);
    }

    .comps-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .comps-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary, #fff);
    }

    .comps-refresh {
      background: none;
      border: none;
      color: var(--text-muted, #888);
      cursor: pointer;
      font-size: 12px;
    }

    .comps-refresh:hover {
      color: var(--primary, #3b82f6);
    }

    .comps-market-context {
      background: #2a2a3e; /* var(--bg-light) fallback */
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .comps-market-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
    }

    .comps-market-label {
      font-size: 12px;
      color: #888;
    }

    .comps-market-value {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .comps-market-value.highlight {
      color: #22c55e;
    }

    .comps-table {
      width: 100%;
      font-size: 12px;
      border-collapse: collapse;
    }

    .comps-table th {
      text-align: left;
      padding: 8px 6px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #333;
    }

    .comps-table td {
      padding: 10px 6px;
      color: #fff;
      border-bottom: 1px solid #222;
    }

    .comps-table tr:hover td {
      background: #2a2a3e;
    }

    .comps-table .address {
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .comps-table .distance {
      color: #888;
    }

    .comps-table .price {
      font-weight: 600;
      color: #4ade80;
    }

    .comps-empty {
      text-align: center;
      padding: 20px;
      color: #888;
      font-size: 13px;
    }

    .comps-loading {
      text-align: center;
      padding: 20px;
      color: #888;
    }

    /* ===== Auth UI ===== */
    .auth-container {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 100;
    }

    .auth-user {
      font-size: 13px;
      color: #888;
    }

    .auth-user-email {
      color: #fff;
      font-weight: 500;
    }

    .auth-btn {
      padding: 8px 16px;
      background: #3b82f6;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-btn:hover {
      background: #2563eb;
    }

    .auth-btn.secondary {
      background: #2a2a3e;
      border: 1px solid #333;
    }

    .auth-btn.secondary:hover {
      background: #3a3a4e;
    }

    /* Login Modal */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .login-modal.open {
      opacity: 1;
      visibility: visible;
    }

    .login-modal-content {
      background: #1a1a2e;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 32px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      position: relative;
    }

    .login-modal-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: #fff;
    }

    .login-modal-subtitle {
      font-size: 14px;
      color: #888;
      margin: 0 0 24px 0;
    }

    .login-input {
      width: 100%;
      padding: 12px 16px;
      background: #2a2a3e;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      margin-bottom: 16px;
      box-sizing: border-box;
    }

    .login-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .login-submit {
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-submit:hover {
      background: #2563eb;
    }

    .login-submit:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .login-message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
    }

    .login-message.success {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .login-message.error {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .login-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }

    /* Portfolio Sync Indicator */
    .portfolio-sync {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #888;
      padding: 4px 8px;
      background: #2a2a3e;
      border-radius: 4px;
    }

    .portfolio-sync.synced {
      color: #22c55e;
    }

    .portfolio-sync-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* View Switching */
    .view-container {
      display: flex;
      flex: 1;
      min-height: 0;
      width: 100%;
    }
    
    /* Dashboard Layout */
    .dashboard-container {
      display: none; /* Hidden by default */
      flex-direction: column;
      padding: 0;
      gap: 20px;
      overflow-y: auto;
    }
    
    .dashboard-row {
      display: flex;
      gap: 20px;
    }
    
    .stat-card {
      flex: 1;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #333;
    }
    
    .stat-card-title {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .stat-card-value {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      flex: 1;
      min-height: 400px;
    }
    
    .dashboard-panel {
      background: #222;
      border-radius: 8px;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      padding: 16px;
      border-bottom: 1px solid #333;
      font-weight: 600;
      color: #fff;
      background: #2a2a2a;
    }
    
    .activity-list {
      padding: 0;
      overflow-y: auto;
      flex: 1;
    }
    
    .activity-item {
      padding: 16px;
      border-bottom: 1px solid #333;
      display: flex;
      gap: 12px;
    }
    
    .activity-icon {
      width: 32px;
      height: 32px;
      background: #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-title {
      font-size: 14px;
      font-weight: 600;
      color: #ddd;
    }
    
    .activity-desc {
      font-size: 13px;
      color: #888;
      margin-top: 2px;
    }
    
    .activity-time {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
    
    /* Nav */
    .nav-tabs {
      display: flex;
      gap: 20px;
      margin-left: 40px;
    }
    
    .nav-tab {
      background: none;
      border: none;
      color: #888;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 0;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .nav-tab:hover { color: #fff; }
    
    .nav-tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    /* Saved Searches */
    .saved-search-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 4px;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .saved-search-item:hover {
      border-color: #444;
      background: #333;
    }
    .saved-search-name {
      color: #ddd;
      flex: 1;
      font-size: 12px;
    }
    .saved-search-actions button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 0 4px;
      font-size: 14px;
    }
    .saved-search-actions button:hover {
      color: #ef4444;
    }

    /* Heatmap Controls */
    .heatmap-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      display: flex;
      gap: 8px;
      background: #222;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #333;
    }
    
    .heatmap-btn {
      padding: 6px 12px;
      background: #333;
      border: 1px solid #444;
      color: #aaa;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .heatmap-btn:hover { background: #444; }
    
    .heatmap-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    /* Heatmap Legend */
    .heatmap-legend {
      position: absolute;
      bottom: 30px;
      left: 20px;
      z-index: 10;
      background: #222;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #333;
      font-size: 11px;
      color: #ccc;
      display: none;
    }
    
    .legend-gradient {
      height: 10px;
      width: 150px;
      margin: 8px 0;
      border-radius: 2px;
      background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
    }
    
    .legend-labels {
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <div style="display:flex; align-items:center;">
      <h1 style="margin-bottom:0; margin-right:40px;">NYC CRE Explorer</h1>
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="showView('map')" id="nav-map">Map</button>
        <button class="nav-tab" onclick="showView('dashboard')" id="nav-dashboard">Dashboard</button>
        <button class="nav-tab" onclick="showView('sources')" id="nav-sources">Data Sources</button>
      </div>
    </div>
    <div id="auth-container" class="auth-container" style="position:static;"></div>
  </div>
  
  <!-- Login Modal -->
  <div id="login-modal" class="login-modal">
    <div class="login-modal-content">
      <button class="login-close" onclick="closeLoginModal()">√ó</button>
      <h2 class="login-modal-title">Sign In</h2>
      <p class="login-modal-subtitle">Enter your email to receive a magic link</p>
      <form onsubmit="handleLogin(event)">
        <input 
          type="email" 
          id="login-email" 
          class="login-input" 
          placeholder="you@example.com"
          required
        />
        <button type="submit" class="login-submit" id="login-submit">
          Send Magic Link
        </button>
      </form>
      <div id="login-message"></div>
    </div>
  </div>
  
  <!-- Save Search Modal -->
  <div id="save-search-modal" class="login-modal">
    <div class="login-modal-content">
      <button class="login-close" onclick="closeSaveSearchModal()">√ó</button>
      <h2 class="login-modal-title">Save Search</h2>
      <p class="login-modal-subtitle">Save current filters for quick access</p>
      <form onsubmit="handleSaveSearch(event)">
        <input 
          type="text" 
          id="search-name" 
          class="login-input" 
          placeholder="e.g. Midtown Office Distress"
          required
        />
        <div style="text-align:left; margin-bottom:16px;">
          <label style="display:flex; align-items:center; gap:8px; color:#ddd; font-size:13px;">
            <input type="checkbox" id="search-alert"> Email alerts for new matches
          </label>
        </div>
        <button type="submit" class="login-submit">Save Search</button>
      </form>
    </div>
  </div>
  
  <div id="map-view" class="view-container container">
    <div class="sidebar">
      <div class="stats">
        <div>
          <div class="stat-value" id="propCount">...</div>
          <div class="stat-label">Total DB</div>
        </div>
        <div>
          <div class="stat-value" id="filterCount">...</div>
          <div class="stat-label">Matching Filters</div>
        </div>
        <div>
          <div class="stat-value" id="salesCount">...</div>
          <div class="stat-label">Sales (30d)</div>
        </div>
      </div>
      <!-- Action Buttons -->
      <div style="padding: 12px; border-bottom: 1px solid #444; display: flex; flex-direction: column; gap: 8px;">
        <div style="display:flex; gap:8px;">
          <button id="portfolioBtn" class="filter-btn" style="flex:1; text-align:center; padding:8px; background:#2a2a3e; border-color:#3b82f6; color:#fff;">
            <span style="margin-right:6px;">‚òÖ</span> My Portfolio
          </button>
          <button id="distressedOwnersBtn" class="filter-btn" onclick="openDistressedOwners()" style="flex:1; text-align:center; padding:8px; background:#333; color:#aaa; border:1px solid #444;">
            ‚ö†Ô∏è Distressed
          </button>
        </div>
        <button id="exportBtn" class="filter-btn" onclick="exportToCSV()" style="width:100%; text-align:center; padding:6px; font-size:11px; opacity:0.7;">
          ‚¨áÔ∏è Export CSV
        </button>
      </div>
      
      <!-- Filters -->
      <div class="filters">
        <div class="filter-row">
          <label class="filter-label">Building Class</label>
          <div class="btn-group">
            <button class="filter-btn active" data-class="all">All</button>
            <button class="filter-btn" data-class="office">Office</button>
            <button class="filter-btn" data-class="retail">Retail</button>
            <button class="filter-btn" data-class="multifam">Multi</button>
            <button class="filter-btn" data-class="industrial">Ind</button>
          </div>
        </div>
        <div class="filter-row">
          <label class="filter-label">Min FAR Gap (Development Potential)</label>
          <select class="filter-select" id="farFilter">
            <option value="">Any</option>
            <option value="1">1.0+ (Some Potential)</option>
            <option value="2">2.0+ (High Potential)</option>
            <option value="4">4.0+ (Massive Potential)</option>
          </select>
        </div>
        <div class="filter-row">
          <label class="filter-label">Distress Signal</label>
          <select class="filter-select" id="distressFilter">
            <option value="">Any Status</option>
            <option value="10">Some Distress (10+)</option>
            <option value="25">High Distress (25+)</option>
          </select>
        </div>
      </div>

      <!-- Saved Searches -->
      <div style="padding: 12px; border-bottom: 1px solid #444; background: #262626;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span style="font-size:11px; color:#888; font-weight:600; text-transform:uppercase;">Saved Searches</span>
          <button onclick="openSaveSearchModal()" style="background:none; border:none; color:#3b82f6; cursor:pointer; font-size:11px;">+ Save Current</button>
        </div>
        <div id="saved-searches-list" style="max-height:100px; overflow-y:auto;">
          <div style="padding:4px; text-align:center; font-style:italic; font-size:11px; color:#666;">Sign in to save searches</div>
        </div>
      </div>

      <div class="list-header">
        <span>Property List</span>
        <span id="listInfo" style="font-weight:normal; color:#aaa;">Loading...</span>
      </div>
      
      <!-- Owner Portfolio Stats (Hidden by default) -->
      <div id="ownerStatsPanel" style="display:none; background:#2a2a2a; padding:12px; margin-bottom:12px; border-left: 3px solid #3b82f6;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="font-weight:bold; color:#fff; font-size:13px;">PORTFOLIO OVERVIEW</div>
          <button onclick="filterByOwner('')" style="background:none; border:none; color:#aaa; cursor:pointer; font-size:16px;">√ó</button>
        </div>
        <div style="color:#3b82f6; font-weight:600; font-size:14px; margin-bottom:8px;" id="osName">Owner Name</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:11px;">
          <div>
            <div style="color:#888;">Properties</div>
            <div style="font-size:13px; color:#ddd;" id="osCount">-</div>
          </div>
          <div>
            <div style="color:#888;">Total SqFt</div>
            <div style="font-size:13px; color:#ddd;" id="osArea">-</div>
          </div>
          <div>
            <div style="color:#888;">Primary Asset</div>
            <div style="font-size:13px; color:#ddd;" id="osType">-</div>
          </div>
          <div>
            <div style="color:#888;">Est. Value</div>
            <div style="font-size:13px; color:#ddd;" id="osValue">-</div>
          </div>
        </div>
      </div>
      
      <div class="list" id="propertyList">
        <div style="padding:20px; text-align:center; color:#666;">Loading...</div>
      </div>
      
      <div class="pagination">
        <button class="page-btn" id="prevBtn" disabled>Previous</button>
        <span id="pageInfo">Page 1</span>
        <button class="page-btn" id="nextBtn" disabled>Next</button>
      </div>
      
    </div>
    
    <div class="main-content">
      <div id="map"></div>
      
      <!-- Heatmap Controls (REMOVED per user request) -->
      <!-- 
      <div class="heatmap-controls">
        <div class="heatmap-group">
          <span class="heatmap-label">Layers</span>
          <button class="heatmap-btn active" onclick="toggleHeatmap('none')">üìç Markers</button>
          <button class="heatmap-btn" onclick="toggleHeatmap('opportunity')">üèôÔ∏è Opportunity</button>
          <button class="heatmap-btn" onclick="toggleHeatmap('price')">üí∞ Price</button>
          <button class="heatmap-btn" onclick="toggleHeatmap('distress')">‚ö†Ô∏è Distress</button>
        </div>
      </div>
      -->
      
      <!-- Heatmap Legend -->
      <div id="heatmap-legend" class="heatmap-legend">
        <div id="legend-title" class="legend-title">Density</div>
        <div id="legend-gradient" class="legend-gradient"></div>
        <div class="legend-labels">
          <span>Low</span>
          <span>High</span>
        </div>
      </div>

      <!-- Distressed Owners View -->
      <div id="distressed-owners-view" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#1a1a1a; z-index:20; padding:20px; overflow-y:auto;">
        <div style="max-width:1000px; margin:0 auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Distressed Owners</h2>
            <button onclick="closeDistressedOwners()" style="background:none; border:1px solid #444; color:#fff; padding:8px 16px; border-radius:4px; cursor:pointer;">Close</button>
          </div>
          
          <div style="background:#2a2a2a; padding:16px; border-radius:8px; margin-bottom:20px;">
            <div style="display:flex; gap:16px; align-items:center;">
              <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:11px; color:#888; text-transform:uppercase;">Min Distress Score</label>
                <select id="do-min-score" onchange="loadDistressedOwners()" style="background:#333; color:#fff; border:1px solid #444; padding:6px; border-radius:4px;">
                  <option value="0">All</option>
                  <option value="20" selected>20+</option>
                  <option value="40">40+</option>
                  <option value="60">60+</option>
                  <option value="80">80+</option>
                </select>
              </div>
              <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size:11px; color:#888; text-transform:uppercase;">Min Properties</label>
                <select id="do-min-props" onchange="loadDistressedOwners()" style="background:#333; color:#fff; border:1px solid #444; padding:6px; border-radius:4px;">
                  <option value="1" selected>1+</option>
                  <option value="2">2+</option>
                  <option value="5">5+</option>
                  <option value="10">10+</option>
                </select>
              </div>
              <div style="flex:1;"></div>
              <button onclick="loadDistressedOwners()" style="background:#3b82f6; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Refresh List</button>
            </div>
          </div>
          
          <div id="distressed-owners-list">
            <!-- List Items -->
          </div>
        </div>
      </div>

      <!-- Floating Detail Panel -->
      <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
          <div>
            <h2 style="font-size:16px; margin-bottom:4px;" id="detailAddress">Address</h2>
            <div style="font-size:11px; color:#888;" id="detailOwner">Owner</div>
          </div>
          <button class="close-btn" onclick="closeDetail()">√ó</button>
        </div>
        <div class="detail-content" id="detailContent">
          <!-- Injected JS -->
        </div>
      </div>
    </div>
  </div>

  <div id="sources-view" class="view-container container" style="display:none; overflow-y:auto; padding:20px; max-width:1000px; margin:0 auto;">
    <div style="margin-bottom:30px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="color:#fff;">NYC Public Data Sources</h2>
        <button onclick="refreshData()" id="refresh-btn" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:600;">
          ‚Üª Repair/Refresh Data
        </button>
      </div>
      <p style="color:#aaa; margin-bottom:20px;">
        This application aggregates data from multiple NYC Open Data APIs. 
        If data appears missing or out of sync, use the "Repair" button above to re-seed the database.
      </p>
      
      <div style="background:#2a2a2a; border-radius:8px; padding:20px; margin-bottom:30px;">
        <h3 style="font-size:14px; color:#888; text-transform:uppercase; margin-bottom:16px;">Primary Data Feeds</h3>
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="text-align:left; border-bottom:1px solid #444;">
              <th style="padding:8px; color:#fff;">Source</th>
              <th style="padding:8px; color:#fff;">Data Provided</th>
              <th style="padding:8px; color:#fff;">Update Frequency</th>
            </tr>
          </thead>
          <tbody style="color:#ddd;">
            <tr style="border-bottom:1px solid #333;">
              <td style="padding:12px 8px;"><strong>PLUTO</strong></td>
              <td style="padding:12px 8px;">Zoning, FAR, Lot/Building Dimensions, Land Use</td>
              <td style="padding:12px 8px;">Monthly</td>
            </tr>
            <tr style="border-bottom:1px solid #333;">
              <td style="padding:12px 8px;"><strong>ACRIS / DOF</strong></td>
              <td style="padding:12px 8px;">Sales history, Deeds, Mortgages, Assessed Values</td>
              <td style="padding:12px 8px;">Daily (Rolling)</td>
            </tr>
            <tr style="border-bottom:1px solid #333;">
              <td style="padding:12px 8px;"><strong>DOB (BIS)</strong></td>
              <td style="padding:12px 8px;">Building Permits, Construction Violations, COs</td>
              <td style="padding:12px 8px;">Weekly</td>
            </tr>
            <tr style="border-bottom:1px solid #333;">
              <td style="padding:12px 8px;"><strong>HPD</strong></td>
              <td style="padding:12px 8px;">Housing Maintenance Code Violations</td>
              <td style="padding:12px 8px;">Daily</td>
            </tr>
            <tr>
              <td style="padding:12px 8px;"><strong>LPC</strong></td>
              <td style="padding:12px 8px;">Landmark Status, Historic Districts</td>
              <td style="padding:12px 8px;">Quarterly</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div style="background:#2a2a2a; border-radius:8px; padding:20px;">
          <h3 style="font-size:14px; color:#888; text-transform:uppercase; margin-bottom:12px;">Derived Metrics</h3>
          <ul style="list-style:none; color:#ddd; font-size:13px; line-height:1.6;">
            <li style="margin-bottom:8px;">‚Ä¢ <strong>FAR Gap:</strong> Calculated difference between Max Allowable FAR and Built FAR. Indicates development potential.</li>
            <li style="margin-bottom:8px;">‚Ä¢ <strong>Distress Score:</strong> Weighted index based on open HPD/DOB violations, lien status, and tax arrears.</li>
            <li style="margin-bottom:8px;">‚Ä¢ <strong>Ownership Tenure:</strong> Time elapsed since last recorded deed transfer.</li>
            <li>‚Ä¢ <strong>Price/SF:</strong> Sale Price divided by Gross Floor Area (where available).</li>
          </ul>
        </div>
        <div style="background:#2a2a2a; border-radius:8px; padding:20px;">
          <h3 style="font-size:14px; color:#888; text-transform:uppercase; margin-bottom:12px;">Data Limitations</h3>
          <ul style="list-style:none; color:#ddd; font-size:13px; line-height:1.6;">
            <li style="margin-bottom:8px;">‚Ä¢ <strong>LLC Transparency:</strong> True beneficial ownership is often obscured behind LLCs. We use Dept of State data where possible.</li>
            <li style="margin-bottom:8px;">‚Ä¢ <strong>Commercial Rents:</strong> NYC does not publish commercial lease comps. Rent estimates are modeled.</li>
            <li>‚Ä¢ <strong>Lag Time:</strong> Public records (ACRIS) may have a 2-4 week recording lag from the transaction date.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboard-view" class="view-container dashboard-container">
    <div id="dashboard-message" style="display:none; padding:40px; text-align:center; height:100%; align-items:center; justify-content:center; flex-direction:column;"></div>
    <div class="dashboard-row" id="dashboard-summary">
      <!-- Stat Cards -->
      <div class="stat-card">
        <div class="stat-card-title">Properties Watched</div>
        <div class="stat-card-value" id="dash-prop-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">Total Value</div>
        <div class="stat-card-value" id="dash-total-value">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">New Violations</div>
        <div class="stat-card-value" id="dash-new-violations">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">Avg FAR Gap</div>
        <div class="stat-card-value" id="dash-avg-gap">-</div>
      </div>
    </div>
    
    <div class="dashboard-grid" id="dashboard-grid">
      <div class="dashboard-panel">
        <div class="panel-header">Recent Activity</div>
        <div class="activity-list" id="activity-feed">
          <div style="padding:20px; text-align:center; color:#666;">Loading activity...</div>
        </div>
      </div>
      
      <div class="dashboard-panel">
        <div class="panel-header">Market Pulse (30d)</div>
        <div style="padding:20px;">
          <div class="stat-card" style="margin-bottom:20px; background:transparent; border:none; padding:0;">
            <div class="stat-card-title">Total Sales</div>
            <div class="stat-card-value" id="pulse-sales">-</div>
          </div>
          <div class="stat-card-title">Avg $/SF by Class</div>
          <div id="pulse-prices" style="margin-top:10px;">
            <!-- JS filled -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Mapbox Token
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWJvci1hZG1pbiIsImEiOiJjbWlxNnU3c2swaWhtM2ZvZW9yMjFlMDFpIn0.X2Ln09z-4sjdww-FodhwbQ';

    // ===== Application State =====
    const state = {
      map: null,
      markers: [],
      properties: [],
      sales: [],
      stats: {},
      filters: {
        bldgclass: 'all',
        minFarGap: null,
        minDistress: null,
        owner: ''
      },
      page: 1,
      limit: 50,
      total: 0
    };
    
    // Aggressively disable telemetry to prevent console errors
    // Note: 'Turnstile' events (billing) cannot be disabled and may still be blocked by ad-blockers.
    try { 
      mapboxgl.config.ENABLE_TELEMETRY = false;
      // Clear local storage to remove pending events from previous sessions
      if (window.localStorage) {
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('mapbox.event')) localStorage.removeItem(key);
        });
      }
    } catch (e) {}

    // ===== Authentication (GUEST MODE) =====
    const auth = {
      user: { email: 'guest@local', id: 'guest' }, // Mock user
      token: 'guest-token',
      
      async init() {
        // Initialize Guest Storage if empty
        if (!localStorage.getItem('guest_portfolios')) {
          localStorage.setItem('guest_portfolios', JSON.stringify([]));
        }
        this.renderAuthUI();
        // Auto-load data since we are "logged in"
        loadPortfolios();
        loadSavedSearches();
      },
      
      async refreshToken() { return; },
      async login(email) { return { success: true }; },
      logout() { },
      
      isLoggedIn() { return true; },
      
      renderAuthUI() {
        const container = document.getElementById('auth-container');
        if (container) container.innerHTML = ''; // Hide UI
      },

      // Intercept API calls for Guest Mode
      fetch(url, options = {}) {
        const method = options.method || 'GET';
        
        // 1. Dashboard Summary
        if (url.includes('/api/dashboard/portfolio-summary')) {
          const portfolios = JSON.parse(localStorage.getItem('guest_portfolios') || '[]');
          let count = 0;
          portfolios.forEach(p => count += (p.properties || []).length);
          return Promise.resolve({
            json: () => Promise.resolve({
              propertyCount: count,
              totalAssessed: 0, // Would need to fetch property details to sum this
              newViolations: 0,
              avgFarGap: 0
            })
          });
        }
        
        // 2. Dashboard Activity
        if (url.includes('/api/dashboard/activity')) {
          // We could log activity to localStorage too, but for now return empty
          return Promise.resolve({ json: () => Promise.resolve({ activities: [] }) });
        }

        // 3. Portfolios List
        if (url === '/api/portfolios' && method === 'GET') {
          const portfolios = JSON.parse(localStorage.getItem('guest_portfolios') || '[]');
          const mapped = portfolios.map(p => ({ ...p, propertyCount: (p.properties || []).length }));
          return Promise.resolve({ json: () => Promise.resolve({ portfolios: mapped }) });
        }

        // 4. Create Portfolio
        if (url === '/api/portfolios' && method === 'POST') {
          const body = JSON.parse(options.body);
          const portfolios = JSON.parse(localStorage.getItem('guest_portfolios') || '[]');
          const newP = {
            id: 'guest-' + Date.now(),
            name: body.name || 'My Portfolio',
            description: body.description,
            created_at: new Date().toISOString(),
            properties: []
          };
          portfolios.push(newP);
          localStorage.setItem('guest_portfolios', JSON.stringify(portfolios));
          return Promise.resolve({ json: () => Promise.resolve({ portfolio: newP }) });
        }

        // 5. Get Portfolio Details
        const idMatch = url.match(/\/api\/portfolios\/([a-zA-Z0-9-]+)$/);
        if (idMatch && method === 'GET') {
          const id = idMatch[1];
          const portfolios = JSON.parse(localStorage.getItem('guest_portfolios') || '[]');
          const p = portfolios.find(x => x.id === id);
          
          // In a real app we'd join with property data. Here we might return bare bones 
          // unless we fetch details. The UI expects `properties` array.
          // We need to return the properties with BBL at least.
          // The UI then might fail to show details if they aren't in `state.properties`.
          // But `showPortfolio` updates `state.properties`.
          // We should try to fetch these BBLs from the server public endpoint?
          // That's hard to sync synchronously here.
          // We'll just return the stored objects. The UI handles partial data.
          
          return Promise.resolve({ json: () => Promise.resolve(p || { properties: [] }) });
        }

        // 6. Add Property
        const addMatch = url.match(/\/api\/portfolios\/([a-zA-Z0-9-]+)\/properties$/);
        if (addMatch && method === 'POST') {
          const id = addMatch[1];
          const body = JSON.parse(options.body);
          const portfolios = JSON.parse(localStorage.getItem('guest_portfolios') || '[]');
          const pIndex = portfolios.findIndex(x => x.id === id);
          if (pIndex >= 0) {
            const newProp = { bbl: body.bbl, notes: body.notes, added_at: new Date().toISOString() };
            if (!portfolios[pIndex].properties) portfolios[pIndex].properties = [];
            
            const existing = portfolios[pIndex].properties.find(prop => prop.bbl === body.bbl);
            if (!existing) {
                portfolios[pIndex].properties.push(newProp);
                localStorage.setItem('guest_portfolios', JSON.stringify(portfolios));
            }
            return Promise.resolve({ json: () => Promise.resolve({ success: true, property: newProp }) });
          }
        }
        
        // 7. Remove Property
        const removeMatch = url.match(/\/api\/portfolios\/([a-zA-Z0-9-]+)\/properties\/(\d+)$/);
        if (removeMatch && method === 'DELETE') {
           const id = removeMatch[1];
           const bbl = removeMatch[2];
           const portfolios = JSON.parse(localStorage.getItem('guest_portfolios') || '[]');
           const pIndex = portfolios.findIndex(x => x.id === id);
           if (pIndex >= 0 && portfolios[pIndex].properties) {
             portfolios[pIndex].properties = portfolios[pIndex].properties.filter(p => p.bbl !== bbl);
             localStorage.setItem('guest_portfolios', JSON.stringify(portfolios));
             return Promise.resolve({ json: () => Promise.resolve({ success: true }) });
           }
        }

        // 8. Saved Searches (Mock)
        if (url === '/api/searches' && method === 'GET') {
             return Promise.resolve({ json: () => Promise.resolve({ searches: [] }) });
        }
        
        // 9. Activity Log (Mock)
        if (url === '/api/activity' && method === 'POST') {
             return Promise.resolve({ json: () => Promise.resolve({ success: true }) });
        }

        // Fallback for public/server requests
        const headers = options.headers || {};
        // No token needed for public endpoints
        return fetch(url, { ...options, headers });
      }
    };

    function openLoginModal() {
      document.getElementById('login-modal').classList.add('open');
      document.getElementById('login-email').focus();
    }

    function closeLoginModal() {
      document.getElementById('login-modal').classList.remove('open');
      document.getElementById('login-message').innerHTML = '';
      document.getElementById('login-email').value = '';
    }

    async function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value;
      const submitBtn = document.getElementById('login-submit');
      const messageDiv = document.getElementById('login-message');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      messageDiv.innerHTML = '';
      
      try {
        const result = await auth.login(email);
        
        if (result.success) {
          messageDiv.innerHTML = `
            <div class="login-message success">
              ‚úì Check your email for the login link!
            </div>
          `;
          // Don't close modal - let user see the message
        } else {
          throw new Error(result.error || 'Login failed');
        }
      } catch (err) {
        messageDiv.innerHTML = `
          <div class="login-message error">
            ${err.message}
          </div>
        `;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Magic Link';
      }
    }

    // ===== Portfolio Management (Authenticated) =====
    let userPortfolios = [];
    let activePortfolioId = null;

    async function loadPortfolios() {
      if (!auth.isLoggedIn()) {
        userPortfolios = [];
        return;
      }
      
      try {
        const response = await auth.fetch('/api/portfolios');
        const data = await response.json();
        
        userPortfolios = data.portfolios || [];
        
        // Auto-create default portfolio if none exist
        if (userPortfolios.length === 0) {
          await createPortfolio('My Portfolio');
        } else {
          activePortfolioId = userPortfolios[0].id;
        }
      } catch (err) {
        console.error('Load portfolios error:', err);
      }
    }

    async function createPortfolio(name) {
      try {
        const response = await auth.fetch('/api/portfolios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        
        const data = await response.json();
        
        if (data.portfolio) {
          userPortfolios.unshift(data.portfolio);
          activePortfolioId = data.portfolio.id;
        }
      } catch (err) {
        console.error('Create portfolio error:', err);
      }
    }

    async function addToPortfolio(bbl, notes = null) {
      if (!auth.isLoggedIn()) {
        if (confirm('Sign in to save properties to your portfolio?')) {
          openLoginModal();
        }
        return;
      }
      
      if (!activePortfolioId) {
        await createPortfolio('My Portfolio');
      }
      
      try {
        const response = await auth.fetch(`/api/portfolios/${activePortfolioId}/properties`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bbl, notes })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Added to portfolio'); 
          loadPortfolios(); // Refresh stats
          logActivity(bbl, 'portfolio_add', { notes });
        }
      } catch (err) {
        console.error('Add to portfolio error:', err);
        alert('Failed to add to portfolio');
      }
    }

    async function removeFromPortfolio(bbl) {
      if (!auth.isLoggedIn() || !activePortfolioId) return;
      
      try {
        await auth.fetch(`/api/portfolios/${activePortfolioId}/properties/${bbl}`, {
          method: 'DELETE'
        });
        
        alert('Removed from portfolio');
        loadPortfolios();
        logActivity(bbl, 'portfolio_remove', {});
      } catch (err) {
        console.error('Remove from portfolio error:', err);
      }
    }

    function isInPortfolio(bbl) {
      return false; // Placeholder
    }

    async function showPortfolio() {
      if (!auth.isLoggedIn()) {
        document.getElementById('propertyList').innerHTML = `
          <div style="padding:20px; text-align:center;">
            <p style="color:#888; margin-bottom:12px;">Sign in to view your saved properties.</p>
            <button onclick="openLoginModal()" class="auth-btn">Sign In</button>
          </div>
        `;
        return;
      }
      
      if (!activePortfolioId) {
        alert('No portfolio found');
        return;
      }
      
      try {
        const response = await auth.fetch(`/api/portfolios/${activePortfolioId}`);
        const data = await response.json();
        
        if (data.properties) {
          state.properties = data.properties;
          state.total = data.properties.length;
          state.page = 1;
          
          updateStats();
          renderList();
          renderMapMarkers();
          
          alert(`Showing ${data.name || 'Portfolio'} (${data.properties.length} properties)`);
        }
      } catch (err) {
        console.error('Show portfolio error:', err);
      }
    }

    // ===== Saved Searches Logic (PRP 3.1) =====
    let savedSearches = [];

    async function loadSavedSearches() {
      // Reloading saved searches
      if (!auth.isLoggedIn()) {
        const el = document.getElementById('saved-searches-list');
        if (el) el.innerHTML = '<div style="padding:4px; text-align:center; font-style:italic; font-size:11px; color:#666;">Sign in to save searches</div>';
        return;
      }
      
      try {
        const response = await auth.fetch('/api/searches');
        const data = await response.json();
        savedSearches = data.searches || [];
        renderSavedSearches();
      } catch (err) {
        console.error('Load searches error:', err);
      }
    }

    function renderSavedSearches() {
      const container = document.getElementById('saved-searches-list');
      if (!container) return;
      
      if (!savedSearches.length) {
        container.innerHTML = '<div style="padding:4px; text-align:center; font-style:italic; font-size:11px; color:#666;">No saved searches</div>';
        return;
      }
      
      container.innerHTML = savedSearches.map(s => `
        <div class="saved-search-item" onclick="applySavedSearch('${s.id}')">
          <div class="saved-search-name">${s.name}</div>
          <div class="saved-search-actions">
            <button onclick="event.stopPropagation(); deleteSavedSearch('${s.id}')">√ó</button>
          </div>
        </div>
      `).join('');
    }

    function openSaveSearchModal() {
      if (!auth.isLoggedIn()) {
        openLoginModal();
        return;
      }
      document.getElementById('save-search-modal').classList.add('open');
      document.getElementById('search-name').focus();
    }

    function closeSaveSearchModal() {
      document.getElementById('save-search-modal').classList.remove('open');
      document.getElementById('search-name').value = '';
    }

    async function handleSaveSearch(event) {
      event.preventDefault();
      
      const name = document.getElementById('search-name').value;
      const alertEnabled = document.getElementById('search-alert').checked;
      
      const filters = { ...state.filters };
      
      try {
        const response = await auth.fetch('/api/searches', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            filters,
            alert_enabled: alertEnabled,
            alert_frequency: 'daily'
          })
        });
        
        const data = await response.json();
        if (data.search) {
          savedSearches.unshift(data.search);
          renderSavedSearches();
          closeSaveSearchModal();
          alert('Search saved!');
        }
      } catch (err) {
        console.error('Save search error:', err);
        alert('Failed to save search');
      }
    }

    function applySavedSearch(id) {
      const search = savedSearches.find(s => s.id === id);
      if (!search) return;
      
      state.filters = { ...search.filters };
      state.page = 1;
      
      document.querySelectorAll('[data-class]').forEach(b => b.classList.remove('active'));
      
      if (state.filters.bldgclass) {
        const btn = document.querySelector(`[data-class="${state.filters.bldgclass}"]`);
        if (btn) btn.classList.add('active');
      } else {
        const allBtn = document.querySelector('[data-class="all"]');
        if (allBtn) allBtn.classList.add('active');
      }
      
      const farSelect = document.getElementById('farFilter');
      if (farSelect) farSelect.value = state.filters.minFarGap || '';
      
      const distressSelect = document.getElementById('distressFilter');
      if (distressSelect) distressSelect.value = state.filters.minDistress || '';
      
      fetchData();
    }

    async function deleteSavedSearch(id) {
      if (!confirm('Delete this saved search?')) return;
      
      try {
        await auth.fetch(`/api/searches/${id}`, { method: 'DELETE' });
        savedSearches = savedSearches.filter(s => s.id !== id);
        renderSavedSearches();
      } catch (err) {
        console.error('Delete search error:', err);
      }
    }

    // App State 
    function filterByOwner(ownerName) {
      // Toggle owner filter
      if (state.filters.owner === ownerName) {
        state.filters.owner = ''; // Clear if clicking same
        alert('Cleared owner filter');
      } else {
        state.filters.owner = ownerName;
        alert(`Filtering by owner: ${ownerName}`);
      }
      state.page = 1;
      fetchData();
    }

    async function fetchData() {
      try {
        const params = new URLSearchParams();
        params.append('limit', '5000');
        if (state.filters.bldgclass !== 'all') params.append('bldgclass', state.filters.bldgclass);
        if (state.filters.minFarGap) params.append('minFarGap', state.filters.minFarGap);
        if (state.filters.minDistress) params.append('minDistress', state.filters.minDistress);
        if (state.filters.owner) params.append('owner', state.filters.owner);
        
        const response = await fetch('/api/data?' + params.toString());
        const data = await response.json();
        
        state.properties = data.properties || [];
        state.sales = data.sales || []; // Save sales
        state.stats = data.stats || {};
        state.total = data.stats.totalCount || state.properties.length;
        
        updateStats();
        renderList();
        renderMapMarkers();
        
      } catch (err) {
        console.error('Error:', err);
      }
    }
    
    function updateStats() {
      const totalDB = state.stats.totalInDatabase || '?';
      const totalFiltered = state.stats.totalCount || state.properties.length;
      document.getElementById('propCount').textContent = totalDB.toLocaleString();
      document.getElementById('filterCount').textContent = totalFiltered.toLocaleString();
      document.getElementById('salesCount').textContent = (state.stats.salesCount || 0).toLocaleString();
      
      // Owner Portfolio Logic
      const osPanel = document.getElementById('ownerStatsPanel');
      if (state.filters.owner) {
        osPanel.style.display = 'block';
        document.getElementById('osName').textContent = state.filters.owner;
        
        // Calculate Stats
        const count = state.properties.length;
        const totalArea = state.properties.reduce((sum, p) => sum + (p.bldgarea || 0), 0);
        
        // Asset Mix
        const types = {};
        state.properties.forEach(p => {
          const type = p.bldgclass_desc || p.bldgclass || 'Other';
          types[type] = (types[type] || 0) + 1;
        });
        const primaryType = Object.entries(types).sort((a,b) => b[1] - a[1])[0]?.[0] || 'Mixed';
        
        // Est Value (Use Assessed Total * 2 as rough market proxy, or just sum Assessed)
        // NYC Assessed is usually 45% of market, so * 2.2 is closer? Let's just show Assessed Total for now to be safe.
        const totalAssessed = state.properties.reduce((sum, p) => sum + (p.assesstot || 0), 0);
        
        document.getElementById('osCount').textContent = count;
        document.getElementById('osArea').textContent = totalArea.toLocaleString() + ' SF';
        document.getElementById('osType').textContent = primaryType;
        document.getElementById('osValue').textContent = '$' + (totalAssessed).toLocaleString(); // Label as "Total Assessed" in mind, or explicit
        
      } else {
        osPanel.style.display = 'none';
      }
    }
    
    function renderList() {
      const container = document.getElementById('propertyList');
      container.innerHTML = '';
      
      const start = (state.page - 1) * state.limit;
      const end = start + state.limit;
      const pageItems = state.properties.slice(start, end);
      
      document.getElementById('listInfo').textContent = `${Math.min(start + 1, state.total)}-${Math.min(end, state.total)} of ${state.total}`;
      document.getElementById('pageInfo').textContent = `Page ${state.page}`;
      document.getElementById('prevBtn').disabled = state.page === 1;
      document.getElementById('nextBtn').disabled = end >= state.total;
      
      pageItems.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = p.bbl;
        card.innerHTML = `
          <div class="card-address">${p.address || 'No address'}</div>
          <div class="card-meta">
            <span class="tag">${p.bldgclass || '?'}</span>
            <span>${(p.bldgarea || 0).toLocaleString()} SF</span>
            ${p.far_gap > 0 ? `<span class="tag" style="color:#4ade80; background:rgba(74, 222, 128, 0.1)">FAR Gap: ${p.far_gap.toFixed(1)}</span>` : ''}
          </div>
        `;
        card.onclick = () => selectProperty(p);
        container.appendChild(card);
      });
    }
    
    function renderMapMarkers() {
      // Clear existing
      state.markers.forEach(m => m.remove());
      state.markers = [];
      
      // Add new markers (limit to 500 for perf)
      const visibleProps = state.properties.slice(0, 500);
      
      visibleProps.forEach(p => {
        // Try lat/lng or latitude/longitude
        const lat = p.lat || p.latitude;
        const lng = p.lng || p.longitude;
        
        if (!lat || !lng) return;
        
        const el = document.createElement('div');
        el.className = 'marker';
        
        // Color coding
        if (p.bldgclass?.startsWith('O')) el.style.background = '#3b82f6'; // Blue Office
        else if (p.bldgclass?.startsWith('K')) el.style.background = '#22c55e'; // Green Retail
        else if (p.bldgclass?.startsWith('D') || p.bldgclass?.startsWith('R')) el.style.background = '#eab308'; // Yellow Resi
        
        el.onclick = (e) => {
          e.stopPropagation();
          selectProperty(p);
        };
        
        const marker = new mapboxgl.Marker(el)
          .setLngLat([lng, lat])
          .addTo(state.map);
          
        state.markers.push(marker);
      });
    }
    
    // ===== Activity Log (PRP 3.3) =====
    async function logActivity(bbl, action, metadata = {}) {
      if (!auth.isLoggedIn()) return;
      try {
        await auth.fetch('/api/activity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bbl, action, metadata })
        });
      } catch (e) {
        console.warn('Failed to log activity:', e);
      }
    }

    // ===== Notes & Tags (PRP 3.3) =====
    async function loadNotes(bbl) {
      const container = document.getElementById('property-notes-container');
      if (!container) return;
      
      if (!auth.isLoggedIn()) {
        container.innerHTML = '<div style="padding:8px; color:#666; font-style:italic; font-size:12px;">Sign in to add notes</div>';
        return;
      }
      
      container.innerHTML = '<div style="padding:8px; color:#666;">Loading notes...</div>';
      
      try {
        const response = await auth.fetch(`/api/notes/${bbl}`);
        const data = await response.json();
        const note = data.note;
        
        renderNotesUI(bbl, note);
      } catch (err) {
        console.error('Load notes error:', err);
        container.innerHTML = '<div style="padding:8px; color:#ef4444;">Error loading notes</div>';
      }
    }
    
    function renderNotesUI(bbl, note) {
      const container = document.getElementById('property-notes-container');
      if (!container) return;
      
      const content = note ? note.content : '';
      const tags = note ? note.tags || [] : [];
      
      const tagsHtml = tags.map(t => `
        <span style="background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-right:4px;">
          ${t} <span onclick="removeTag('${bbl}', '${t}')" style="cursor:pointer; margin-left:4px;">√ó</span>
        </span>
      `).join('');
      
      container.innerHTML = `
        <div style="margin-bottom:8px;">
          <textarea id="note-content" placeholder="Add private notes..." style="width:100%; height:80px; background:#1a1a1a; border:1px solid #333; color:#ddd; padding:8px; border-radius:4px; font-size:12px;">${content || ''}</textarea>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
            <div style="font-size:11px; color:#888;">${note ? 'Last updated: ' + new Date(note.updated_at).toLocaleDateString() : ''}</div>
            <button onclick="saveNote('${bbl}')" style="background:#2563eb; color:white; border:none; padding:4px 12px; border-radius:4px; cursor:pointer; font-size:11px;">Save Note</button>
          </div>
        </div>
        <div style="border-top:1px solid #333; padding-top:8px;">
          <div style="font-size:11px; color:#888; margin-bottom:4px;">TAGS</div>
          <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:4px;">
            ${tagsHtml}
            <button onclick="showTagInput('${bbl}')" style="background:#333; color:#aaa; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; font-size:10px;">+ Add Tag</button>
          </div>
          <div id="tag-input-container" style="display:none; margin-top:4px;">
            <input type="text" id="new-tag-input" placeholder="New tag..." style="background:#1a1a1a; border:1px solid #333; color:#fff; padding:2px 6px; font-size:11px; width:80px;">
            <button onclick="addTag('${bbl}')" style="background:#2563eb; color:white; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; font-size:11px;">Add</button>
          </div>
        </div>
      `;
    }
    
    async function saveNote(bbl) {
      const content = document.getElementById('note-content').value;
      // Get existing tags (this is a bit hacky, ideally we store state)
      // We'll just fetch them again or assume simpler for now - let's just use what's in DB + UI? 
      // Actually, let's just save content and keep tags as is, but our API expects both.
      // Better to fetch current note first or store in a variable.
      // Let's re-fetch to be safe/simple for this MVP.
      
      try {
        const currentRes = await auth.fetch(`/api/notes/${bbl}`);
        const currentData = await currentRes.json();
        const tags = currentData.note ? currentData.note.tags : [];
        
        const response = await auth.fetch('/api/notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bbl, content, tags })
        });
        
        const data = await response.json();
        renderNotesUI(bbl, data.note);
        logActivity(bbl, 'note', { action: 'update_content' });
        alert('Note saved');
      } catch (err) {
        console.error('Save note error:', err);
        alert('Failed to save note');
      }
    }
    
    function showTagInput() {
      document.getElementById('tag-input-container').style.display = 'block';
      document.getElementById('new-tag-input').focus();
    }
    
    async function addTag(bbl) {
      const tag = document.getElementById('new-tag-input').value.trim();
      if (!tag) return;
      
      try {
        const currentRes = await auth.fetch(`/api/notes/${bbl}`);
        const currentData = await currentRes.json();
        const currentTags = currentData.note ? currentData.note.tags || [] : [];
        const currentContent = currentData.note ? currentData.note.content : '';
        
        if (!currentTags.includes(tag)) {
          const newTags = [...currentTags, tag];
          
          const response = await auth.fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bbl, content: currentContent, tags: newTags })
          });
          
          const data = await response.json();
          renderNotesUI(bbl, data.note);
          logActivity(bbl, 'note', { action: 'add_tag', tag });
        }
      } catch (err) {
        console.error('Add tag error:', err);
      }
    }
    
    async function removeTag(bbl, tag) {
      try {
        const currentRes = await auth.fetch(`/api/notes/${bbl}`);
        const currentData = await currentRes.json();
        const currentTags = currentData.note ? currentData.note.tags || [] : [];
        const currentContent = currentData.note ? currentData.note.content : '';
        
        const newTags = currentTags.filter(t => t !== tag);
        
        const response = await auth.fetch('/api/notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bbl, content: currentContent, tags: newTags })
        });
        
        const data = await response.json();
        renderNotesUI(bbl, data.note);
      } catch (err) {
        console.error('Remove tag error:', err);
      }
    }

    async function selectProperty(initialP) {
      // Highlight in list
      document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
      const card = document.querySelector(`.card[data-id="${initialP.bbl}"]`);
      if (card) {
        card.classList.add('active');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // Map Flyto
      const lat = initialP.lat || initialP.latitude;
      const lng = initialP.lng || initialP.longitude;
      if (lat && lng) {
        state.map.flyTo({ center: [lng, lat], zoom: 16 });
      }

      // Show Panel with Loading State
      const panel = document.getElementById('detailPanel');
      const content = document.getElementById('detailContent');
      panel.style.display = 'block';
      
      document.getElementById('detailAddress').textContent = initialP.address || 'Loading...';
      document.getElementById('detailOwner').textContent = initialP.ownername || '...';
      content.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Loading property details...</div>';

      try {
        // Fetch Full Details (including violations)
        const response = await fetch(`/api/properties/${initialP.bbl}`);
        const p = await response.json();
        
        // Show Details
        const landmarkBadge = p.landmark ? `<span style="background:#fbbf24; color:#000; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold; margin-left:8px; vertical-align:middle;">LANDMARK</span>` : '';
        document.getElementById('detailAddress').innerHTML = p.address + landmarkBadge;
        
        const ownerEl = document.getElementById('detailOwner');
        if (p.ownername) {
          ownerEl.innerHTML = `<a href="#" onclick="filterByOwner('${p.ownername.replace(/'/g, "\\'")}'); return false;" style="color:#3b82f6; text-decoration:underline;">${p.ownername}</a>`;
        } else {
          ownerEl.textContent = 'Unknown Owner';
        }
        
        // ACRIS Link
        const boro = { '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', 'MN': '1', 'BX': '2', 'BK': '3', 'QN': '4', 'SI': '5' }[p.borough] || '1';
        const block = String(p.block).padStart(5, '0');
        const lot = String(p.lot).padStart(4, '0');
        const acrisUrl = `https://a836-acris.nyc.gov/bblsearch/bblsearch.asp?borough=${boro}&block=${block}&lot=${lot}`;
        
        // Calculate Metrics
        const maxFar = p.max_far || Math.max(p.residfar || 0, p.commfar || 0, p.facilfar || 0);
        const builtFar = p.built_far || p.builtfar || 0;
        
        // Generate Sales HTML
        let salesHtml = '';
        
        // 1. Definitive Last Sale (from PLUTO)
        if (p.last_sale_date) {
           salesHtml += `
             <div style="margin-bottom:12px; padding:12px; background:rgba(59, 130, 246, 0.15); border-radius:4px; border:1px solid #3b82f6;">
               <div style="font-size:10px; color:#93c5fd; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Last Recorded Sale</div>
               <div style="font-size:16px; font-weight:bold; color:#fff;">$${(p.last_sale_price || 0).toLocaleString()}</div>
               <div style="font-size:12px; color:#bfdbfe; margin-top:2px;">${p.last_sale_date}</div>
             </div>
           `;
        } else if (!p.sales || p.sales.length === 0) {
           salesHtml += '<div style="color:#888; font-size:12px; font-style:italic; margin-bottom:12px;">No sales history available</div>';
        }

        // 2. Recent Sales List
        if (p.sales && p.sales.length > 0) {
          salesHtml += '<div style="font-size:11px; color:#888; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">Recent Activity (3yr)</div>';
          salesHtml += p.sales.map(s => `
            <div class="sales-row" style="border-left:2px solid #444; padding-left:10px; margin-bottom:8px;">
              <div style="font-size:12px; color:#ddd;">${s.sale_date}</div>
              <div style="font-size:11px; color:#888;">$${(s.sale_price || 0).toLocaleString()}</div>
            </div>
          `).join('');
        } else if (p.last_sale_date) {
             salesHtml += '<div style="font-size:11px; color:#666; font-style:italic;">No other recent activity found (Last 3 Years)</div>';
        }

        // Generate Violations HTML
        let distressHtml = '';
        if (p.violations && p.violations.length > 0) {
          const openViolations = p.violations.filter(v => v.status === 'Open');
          if (openViolations.length > 0) {
            distressHtml = `
              <div class="detail-section">
                <div class="section-title" style="color:#ef4444;">‚ö†Ô∏è Distress Signals</div>
                <div style="background:rgba(239, 68, 68, 0.1); border:1px solid rgba(239, 68, 68, 0.3); border-radius:4px; padding:12px;">
                  <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="color:#ef4444; font-weight:600;">Open Violations</span>
                    <span style="color:#fff; font-weight:bold;">${openViolations.length}</span>
                  </div>
                  <div style="max-height:150px; overflow-y:auto;">
                    ${openViolations.slice(0, 10).map(v => `
                      <div style="font-size:11px; margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <div style="display:flex; justify-content:space-between; color:#aaa;">
                          <span>${v.violation_type}</span>
                          <span>${new Date(v.issue_date).toLocaleDateString()}</span>
                        </div>
                        <div style="color:#ddd; margin-top:2px;">${v.description || 'No description'}</div>
                      </div>
                    `).join('')}
                  </div>
                  ${openViolations.length > 10 ? `<div style="text-align:center; font-size:10px; color:#aaa; margin-top:4px;">+ ${openViolations.length - 10} more</div>` : ''}
                </div>
              </div>
            `;
          }
        }
        
        content.innerHTML = `
          <!-- Location Info -->
          <div class="detail-section">
            <div class="section-title">Location</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; font-size:13px;">
              <div>
                <div style="color:#888; font-size:11px;">Borough</div>
                <div>${{ '1': 'Manhattan', '2': 'Bronx', '3': 'Brooklyn', '4': 'Queens', '5': 'Staten Island' }[String(p.borough || (p.bbl ? p.bbl.toString().charAt(0) : ''))] || '-'}</div>
              </div>
              <div>
                <div style="color:#888; font-size:11px;">Block / Lot</div>
                <div>${p.block} / ${p.lot}</div>
              </div>
              <div>
                <div style="color:#888; font-size:11px;">BBL</div>
                <div style="font-family:monospace; color:#aaa;">${p.bbl}</div>
              </div>
              <div>
                <div style="color:#888; font-size:11px;">Zoning</div>
                <div>${p.zonedist1 || '-'}</div>
              </div>
            </div>
          </div>

          <!-- Building Info -->
          <div class="detail-section">
            <div class="section-title">Building & Lot</div>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-label">Class</div>
                <div class="metric-value" title="${p.bldgclass_desc}">${p.bldgclass} ${p.extension ? `<span style="color:#aaa; font-size:10px;">(${p.extension})</span>` : ''}</div>
              </div>
              <div class="metric-box">
                <div class="metric-label">Built / Alt</div>
                <div class="metric-value">${p.yearbuilt || '-'} ${p.year_altered ? `<span style="color:#4ade80; font-size:10px;" title="Last Major Alteration">/ '${String(p.year_altered).slice(2)}</span>` : ''}</div>
              </div>
              <div class="metric-box">
                <div class="metric-label">Lot Dim</div>
                <div class="metric-value">${p.lot_front || '?'} x ${p.lot_depth || '?'}</div>
              </div>
              <div class="metric-box">
                <div class="metric-label">Lot Area</div>
                <div class="metric-value">${(p.lotarea || 0).toLocaleString()} SF</div>
              </div>
            </div>
          </div>
          
          <!-- Financial -->
          <div class="detail-section">
            <div class="section-title">Valuation</div>
            <div style="background:#2a2a2a; padding:12px; border-radius:4px;">
               <div style="display:flex; justify-content:space-between; align-items:center;">
                 <span style="color:#888; font-size:12px;">Assessed Value</span>
                 <span style="font-size:16px; font-weight:600; color:#fff;">$${(p.assesstot || 0).toLocaleString()}</span>
               </div>
            </div>
          </div>

          ${distressHtml}
          
          <!-- Development Potential -->
          <div class="detail-section">
            <div class="section-title">Development Potential</div>
            <div style="padding:12px; background:#2a2a2a; border-radius:4px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <span style="color:#aaa; font-size:12px;">FAR Gap</span>
                <span style="font-weight:bold; font-size:18px; color:${p.far_gap > 0 ? '#4ade80' : '#aaa'}">
                  ${p.far_gap ? p.far_gap.toFixed(2) : '0.00'}
                </span>
              </div>
              
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:4px; margin-bottom:12px; text-align:center;">
                <div style="background:#333; padding:4px; border-radius:4px;">
                  <div style="font-size:9px; color:#888;">RESID</div>
                  <div style="font-size:11px; font-weight:600;">${p.residfar || 0}</div>
                </div>
                <div style="background:#333; padding:4px; border-radius:4px;">
                  <div style="font-size:9px; color:#888;">COMM</div>
                  <div style="font-size:11px; font-weight:600;">${p.commfar || 0}</div>
                </div>
                <div style="background:#333; padding:4px; border-radius:4px;">
                  <div style="font-size:9px; color:#888;">FACIL</div>
                  <div style="font-size:11px; font-weight:600;">${p.facilfar || 0}</div>
                </div>
                <div style="background:#2a2a3e; padding:4px; border-radius:4px; border:1px solid #3b82f6;">
                  <div style="font-size:9px; color:#3b82f6;">BUILT</div>
                  <div style="font-size:11px; font-weight:600;">${builtFar.toFixed(2)}</div>
                </div>
              </div>

              <div style="padding-top:8px; border-top:1px solid #444; font-size:11px; color:#ddd; display:flex; justify-content:space-between;">
                <span>Unused Air Rights:</span>
                <strong style="color:#fff;">${(p.unused_sf || 0).toLocaleString()} SF</strong>
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <div class="section-title">Sales History</div>
            ${salesHtml}
          </div>

          <div class="detail-section">
            <div class="section-title">Notes & Tags</div>
            <div id="property-notes-container" style="background:#222; padding:8px; border-radius:4px; min-height:60px;">
              Loading...
            </div>
          </div>
          
          <div class="detail-section">
            <div class="section-title">Actions</div>
            <button class="link-btn" onclick="addToPortfolio('${p.bbl}')" style="background:#3b82f6; color:white; font-weight:600;">‚òÖ Add to Portfolio</button>
            <button class="link-btn" onclick="generatePropertyPDF('${p.bbl}')" style="background:#ef4444; color:white; font-weight:600;">‚¨á PDF Report</button>
            <a href="${acrisUrl}" target="_blank" class="link-btn">View Deeds (ACRIS) ‚Üó</a>
            <a href="https://a810-bisweb.nyc.gov/bisweb/PropertyProfileOverviewServlet?boro=${boro}&block=${p.block}&lot=${p.lot}" target="_blank" class="link-btn">View Permits (DOB) ‚Üó</a>
          </div>

          <!-- Comparable Sales Section -->
          <div id="comps-section" class="comps-section" style="display: none;">
            <div class="comps-header">
              <span class="comps-title">Comparable Sales</span>
              <button class="comps-refresh" onclick="loadComps('${p.bbl}')">‚Üª Refresh</button>
            </div>
            <div id="comps-content">
              <!-- Filled by JS -->
            </div>
          </div>
        `;
        
        // Load Comps
        loadComps(p.bbl);
        
        // Load Notes
        loadNotes(p.bbl);
        
        // Log View
        logActivity(p.bbl, 'view', { address: p.address });

      } catch (err) {
        console.error('Error loading property details:', err);
        content.innerHTML = '<div style="color:#ef4444; text-align:center; padding:20px;">Error loading property details</div>';
      }
    }
    
    function closeDetail() {
      document.getElementById('detailPanel').classList.remove('visible');
    }
    
    function setupPagination() {
      document.getElementById('prevBtn').onclick = () => {
        if (state.page > 1) { state.page--; renderList(); }
      };
      document.getElementById('nextBtn').onclick = () => {
        const maxPage = Math.ceil(state.total / state.limit);
        if (state.page < maxPage) { state.page++; renderList(); }
      };
    }

    // ===== Comparable Sales (PRP 1.2) =====
    async function loadComps(bbl) {
      const content = document.getElementById('comps-content');
      if (!content) return;
      
      content.innerHTML = '<div class="comps-loading">Loading comparables...</div>';
      
      try {
        const response = await fetch(`/api/properties/${bbl}/comps?radius=0.25&limit=5`);
        const data = await response.json();
        
        renderComps(data);
        
      } catch (error) {
        console.error('Comps error:', error);
        content.innerHTML = `<div class="comps-empty">Unable to load comparables</div>`;
      }
    }

    function renderComps(data) {
      const content = document.getElementById('comps-content');
      if (!content) return;
      
      const { subject, comps, marketStats } = data;
      
      if (!comps || comps.length === 0) {
        content.innerHTML = '<div class="comps-empty">No comparable sales found nearby</div>';
        return;
      }
      
      // Market context box
      let marketHtml = '';
      if (marketStats) {
        // Calculate subject vs market
        let vsMarketHtml = '';
        if (subject.pricePerSF && marketStats.avgPricePerSF) {
          const diff = subject.pricePerSF - marketStats.avgPricePerSF;
          const pctDiff = Math.round((diff / marketStats.avgPricePerSF) * 100);
          const diffClass = pctDiff > 5 ? 'color:#ef4444' : pctDiff < -5 ? 'color:#22c55e' : 'color:#fff';
          const diffSign = pctDiff > 0 ? '+' : '';
          
          vsMarketHtml = `
            <div style="display:flex; gap:8px; margin-top:8px; padding-top:8px; border-top:1px dashed #444;">
              <div style="flex:1; text-align:center; padding:4px; background:#1a1a2e; border-radius:4px;">
                <div style="font-size:10px; color:#888;">SUBJECT $/SF</div>
                <div style="font-weight:700;">$${subject.pricePerSF.toLocaleString()}</div>
              </div>
              <div style="flex:1; text-align:center; padding:4px; background:#1a1a2e; border-radius:4px;">
                <div style="font-size:10px; color:#888;">MARKET</div>
                <div style="font-weight:700;">$${marketStats.avgPricePerSF.toLocaleString()}</div>
              </div>
              <div style="flex:1; text-align:center; padding:4px; background:#1a1a2e; border-radius:4px;">
                <div style="font-size:10px; color:#888;">DIFF</div>
                <div style="font-weight:700; ${diffClass}">${diffSign}${pctDiff}%</div>
              </div>
            </div>
          `;
        }
        
        marketHtml = `
          <div class="comps-market-context">
            <div class="comps-market-stat">
              <span class="comps-market-label">Avg $/SF (${marketStats.count} sales)</span>
              <span class="comps-market-value">$${marketStats.avgPricePerSF.toLocaleString()}</span>
            </div>
            <div class="comps-market-stat">
              <span class="comps-market-label">Median $/SF</span>
              <span class="comps-market-value">$${marketStats.medianPricePerSF.toLocaleString()}</span>
            </div>
            ${vsMarketHtml}
          </div>
        `;
      }
      
      // Comps table
      const tableRows = comps.map(comp => {
        const saleDate = comp.sale_date 
          ? new Date(comp.sale_date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
          : '-';
        const price = comp.sale_price 
          ? '$' + (comp.sale_price / 1000000).toFixed(2) + 'M'
          : '-';
        const ppsf = comp.price_per_sf 
          ? '$' + comp.price_per_sf.toLocaleString()
          : '-';
        
        // Handle missing address/distance gracefully
        const addr = comp.address || comp.bbl;
        const dist = comp.dist_miles || '?';
        
        return `
          <tr onclick="selectProperty({bbl: '${comp.bbl}', lat: ${state.properties.find(p=>p.bbl===comp.bbl)?.lat || 0}, lng: ${state.properties.find(p=>p.bbl===comp.bbl)?.lng || 0}})" style="cursor: pointer;">
            <td class="address" title="${addr}">${addr}</td>
            <td class="distance">${dist}mi</td>
            <td>${(comp.bldgarea || 0).toLocaleString()}</td>
            <td class="price">${price}</td>
            <td>${ppsf}</td>
            <td>${saleDate}</td>
          </tr>
        `;
      }).join('');
      
      const tableHtml = `
        <table class="comps-table">
          <thead>
            <tr>
              <th>Address</th>
              <th>Dist</th>
              <th>SF</th>
              <th>Price</th>
              <th>$/SF</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      `;
      
      content.innerHTML = marketHtml + tableHtml;
    }

    // ===== Dashboard Logic (PRP 2.1) =====
    function showView(viewName) {
      // Toggle Nav
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(`nav-${viewName}`).classList.add('active');
      
      // Toggle Views
      document.getElementById('map-view').style.display = viewName === 'map' ? 'flex' : 'none';
      document.getElementById('dashboard-view').style.display = viewName === 'dashboard' ? 'flex' : 'none';
      document.getElementById('sources-view').style.display = viewName === 'sources' ? 'block' : 'none';
      
      // Load Data
      if (viewName === 'dashboard') {
        loadDashboard();
      } else if (viewName === 'map') {
        state.map.resize(); 
      }
    }

    async function loadDashboard() {
      // Auth Check
      if (!auth.isLoggedIn()) {
        document.getElementById('dashboard-summary').style.display = 'none';
        document.getElementById('dashboard-grid').style.display = 'none';
        const msg = document.getElementById('dashboard-message');
        msg.style.display = 'flex';
        msg.innerHTML = `
          <h2 style="margin-bottom:16px; color:#fff;">Sign In Required</h2>
          <p style="color:#888; margin-bottom:24px; max-width:400px;">Sign in to view your portfolio dashboard, track properties, and monitor activity.</p>
          <button onclick="openLoginModal()" class="auth-btn" style="font-size:16px; padding:10px 24px;">Sign In / Register</button>
        `;
        return;
      }

      try {
        const [summary, activity, market] = await Promise.all([
          auth.fetch('/api/dashboard/portfolio-summary').then(r => r.json()),
          auth.fetch('/api/dashboard/activity').then(r => r.json()),
          fetch('/api/dashboard/market-pulse').then(r => r.json())
        ]);
        
        renderDashboard({ summary, activity, market });
      } catch (err) {
        console.error('Dashboard load error:', err);
      }
    }

    function renderDashboard(data) {
      const { summary, activity, market } = data;
      
      // Reset View
      document.getElementById('dashboard-message').style.display = 'none';
      document.getElementById('dashboard-summary').style.display = 'flex';
      document.getElementById('dashboard-grid').style.display = 'grid';
      
      // Summary
      document.getElementById('dash-prop-count').textContent = summary.propertyCount || 0;
      document.getElementById('dash-total-value').textContent = summary.totalAssessed 
        ? '$' + (summary.totalAssessed / 1000000).toFixed(1) + 'M' 
        : '-';
      document.getElementById('dash-new-violations').textContent = summary.newViolations || 0;
      document.getElementById('dash-avg-gap').textContent = summary.avgFarGap 
        ? summary.avgFarGap.toFixed(2) 
        : '-';
        
      // Activity
      const feed = document.getElementById('activity-feed');
      if (activity.activities && activity.activities.length > 0) {
        feed.innerHTML = activity.activities.map(a => {
          let icon = 'üìù';
          if (a.action === 'view') icon = 'üëÄ';
          if (a.action === 'portfolio_add') icon = '‚≠ê';
          if (a.action === 'note') icon = '‚úèÔ∏è';
          if (a.action === 'export') icon = '‚¨áÔ∏è';
          
          let title = a.action ? a.action.replace('_', ' ').toUpperCase() : 'ACTIVITY';
          let desc = a.bbl || 'Activity';
          
          if (a.type === 'sale') { title = 'üí∞ SALE'; icon = 'üí∞'; }
          if (a.type === 'violation') { title = '‚ö†Ô∏è VIOLATION'; icon = '‚ö†Ô∏è'; }
          
          if (a.title) title = a.title; // Use server title if avail
          if (a.description) desc = a.description;
          
          if (a.metadata && a.metadata.address) desc = a.metadata.address;
          if (a.action === 'note' && a.metadata.snippet) desc = `Note: "${a.metadata.snippet}..."`;
          
          return `
            <div class="activity-item">
              <div class="activity-icon">${icon}</div>
              <div class="activity-content">
                <div class="activity-title">${title}</div>
                <div class="activity-desc">${desc}</div>
                <div class="activity-time">${new Date(a.date || a.created_at).toLocaleString()}</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        feed.innerHTML = `
          <div style="padding:30px; text-align:center; color:#666;">
            <div style="font-size:24px; margin-bottom:8px;">üì≠</div>
            <div>No recent activity</div>
            <div style="font-size:11px; margin-top:4px;">Add properties to your portfolio to track them</div>
          </div>
        `;
      }
      
      // Market
      document.getElementById('pulse-sales').textContent = market.salesCount || 0;
      
      const prices = document.getElementById('pulse-prices');
      if (market.psfByClass) {
        prices.innerHTML = Object.entries(market.psfByClass).map(([cls, price]) => `
          <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;">
            <span style="color:#aaa;">${cls} Class</span>
            <span style="color:#fff; font-weight:600;">$${price}/sf</span>
          </div>
        `).join('');
      }
    }

    // ===== Data Refresh =====
    async function refreshData() {
      if (!auth.isLoggedIn()) {
        alert('Please sign in to refresh data.');
        return;
      }
      
      if (!confirm('This will re-seed the violation database. It may take a few seconds. Continue?')) return;
      
      const btn = document.getElementById('refresh-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Running Repair...';
      
      try {
        const response = await auth.fetch('/api/admin/seed', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          alert('‚úÖ Data repair successful!\n\nViolations have been re-seeded. Filters should now work correctly.');
          // Refresh current view
          fetchData();
        } else {
          alert('‚ùå Repair failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Refresh error:', err);
        alert('‚ùå Error connecting to server');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // ===== Heatmap Logic (DISABLED) =====
    /*
    let activeHeatmap = 'none';

    async function toggleHeatmap(metric) {
      // ... removed ...
    }
    */

    // ===== Export Functions (PRP 3.2) =====
    function exportToCSV() {
      if (!state.properties || state.properties.length === 0) {
        alert('No properties to export');
        return;
      }
      
      const headers = [
        'BBL', 'Address', 'Borough', 'Block', 'Lot', 'Owner', 'Class', 
        'BldgArea', 'LotArea', 'ResidFAR', 'CommFAR', 'FacilFAR', 'BuiltFAR',
        'FAR Gap', 'Unused SF', 'Assessed Value', 'Zoning', 'Year Built'
      ];
      
      const rows = state.properties.map(p => [
        p.bbl,
        p.address,
        p.borough,
        p.block,
        p.lot,
        p.ownername,
        p.bldgclass,
        p.bldgarea,
        p.lotarea,
        p.residfar,
        p.commfar,
        p.facilfar,
        p.builtfar,
        p.far_gap,
        p.unused_sf,
        p.assesstot,
        p.zonedist1,
        p.yearbuilt
      ]);
      
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(val => {
          if (val === null || val === undefined) return '';
          const str = String(val);
          if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return `"${str.replace(/"/g, '""')}"`;
          }
          return str;
        }).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `nyc_cre_export_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      logActivity(null, 'export', { type: 'csv', count: state.properties.length });
    }

    async function generatePropertyPDF(bbl) {
      const { jsPDF } = window.jspdf;
      if (!jsPDF) {
        alert('PDF library not loaded');
        return;
      }
      
      const p = state.properties.find(prop => prop.bbl === bbl);
      if (!p) return;
      
      const doc = new jsPDF();
      
      // Header
      doc.setFontSize(20);
      doc.setTextColor(40, 40, 40);
      doc.text(p.address || 'Property Report', 20, 20);
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(`BBL: ${p.bbl} | Class: ${p.bldgclass} | Owner: ${p.ownername || 'Unknown'}`, 20, 30);
      
      // Line
      doc.setDrawColor(200, 200, 200);
      doc.line(20, 35, 190, 35);
      
      // Key Stats Grid
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('Property Details', 20, 45);
      
      const stats = [
        ['Building Area', `${(p.bldgarea || 0).toLocaleString()} SF`],
        ['Lot Area', `${(p.lotarea || 0).toLocaleString()} SF`],
        ['Year Built', p.yearbuilt || '-'],
        ['Zoning', p.zonedist1 || '-'],
        ['Assessed Value', `$${(p.assesstot || 0).toLocaleString()}`],
        ['Tax Class', p.taxclass || '-']
      ];
      
      doc.autoTable({
        startY: 50,
        head: [['Metric', 'Value']],
        body: stats,
        theme: 'striped',
        headStyles: { fillColor: [59, 130, 246] }
      });
      
      // Development Potential
      const currentY = doc.lastAutoTable.finalY + 15;
      doc.setFontSize(14);
      doc.text('Development Potential', 20, currentY);
      
      const devStats = [
        ['Max FAR', (p.max_far || 0).toFixed(2)],
        ['Built FAR', (p.builtfar || 0).toFixed(2)],
        ['FAR Gap', (p.far_gap || 0).toFixed(2)],
        ['Unused Air Rights', `${(p.unused_sf || 0).toLocaleString()} SF`]
      ];
      
      doc.autoTable({
        startY: currentY + 5,
        head: [['Metric', 'Value']],
        body: devStats,
        theme: 'grid',
        headStyles: { fillColor: [34, 197, 94] } // Green for opportunity
      });
      
      // Sales History
      const propSales = state.sales.filter(s => s.bbl === p.bbl);
      if (propSales.length > 0) {
        const salesY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.text('Recent Sales', 20, salesY);
        
        const salesRows = propSales.map(s => [
          s.sale_date,
          `$${(s.sale_price || 0).toLocaleString()}`,
          s.deed_type || '-'
        ]);
        
        doc.autoTable({
          startY: salesY + 5,
          head: [['Date', 'Price', 'Type']],
          body: salesRows,
          theme: 'striped'
        });
      }
      
      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.setTextColor(150);
        doc.text(`NYC CRE Explorer - Generated ${new Date().toLocaleDateString()}`, 20, 285);
        doc.text(`Page ${i} of ${pageCount}`, 170, 285);
      }
      
      doc.save(`${p.address.replace(/[^a-z0-9]/gi, '_')}_report.pdf`);
      
      logActivity(bbl, 'export', { type: 'pdf', address: p.address });
    }

    // ===== Distressed Owners (PRP 4.1) =====
    function openDistressedOwners() {
      document.getElementById('distressed-owners-view').style.display = 'block';
      loadDistressedOwners();
    }
    
    function closeDistressedOwners() {
      document.getElementById('distressed-owners-view').style.display = 'none';
    }
    
    async function loadDistressedOwners() {
      const list = document.getElementById('distressed-owners-list');
      list.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Loading distressed owners...</div>';
      
      const minScore = document.getElementById('do-min-score').value;
      const minProps = document.getElementById('do-min-props').value;
      
      try {
        const response = await fetch(`/api/owners/distressed?minScore=${minScore}&minProperties=${minProps}`);
        const data = await response.json();
        
        if (!data.owners || data.owners.length === 0) {
          list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No distressed owners found matching criteria.</div>';
          return;
        }
        
        renderDistressedOwners(data.owners);
      } catch (err) {
        console.error('Load distressed owners error:', err);
        list.innerHTML = '<div style="padding:20px; text-align:center; color:#ef4444;">Error loading data</div>';
      }
    }
    
    function renderDistressedOwners(owners) {
      const list = document.getElementById('distressed-owners-list');
      
      list.innerHTML = owners.map(o => {
        let scoreColor = '#9ca3af';
        if (o.distressScore >= 70) scoreColor = '#ef4444';
        else if (o.distressScore >= 50) scoreColor = '#f97316';
        else if (o.distressScore >= 30) scoreColor = '#eab308';
        
        return `
          <div class="distressed-owner-card" style="background:#222; padding:16px; border-radius:8px; margin-bottom:12px; border-left:4px solid ${scoreColor};">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
              <div>
                <div style="font-size:18px; font-weight:bold; margin-bottom:4px; color:#fff;">
                  ${o.name} <span style="font-size:12px; font-weight:normal; color:#888; margin-left:8px; background:#333; padding:2px 6px; border-radius:4px;">${o.entityType}</span>
                </div>
                <div style="color:#aaa; font-size:13px; margin-bottom:8px;">
                  ${o.propertyCount} properties ¬∑ $${(o.totalAssessed / 1000000).toFixed(1)}M Value ¬∑ <span style="color:#ef4444;">${o.openViolations} Open Violations</span>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  ${o.topIssues.map(issue => `<span style="background:rgba(239, 68, 68, 0.1); color:#ef4444; border:1px solid rgba(239, 68, 68, 0.2); padding:2px 8px; border-radius:12px; font-size:11px;">${issue}</span>`).join('')}
                </div>
              </div>
              
              <div style="text-align:right;">
                <div style="font-size:24px; font-weight:bold; color:${scoreColor};">${o.distressScore}</div>
                <div style="font-size:10px; color:#666; text-transform:uppercase;">Distress Score</div>
                <button onclick="filterByOwner('${o.name.replace(/'/g, "\\'")}')" style="margin-top:8px; background:#3b82f6; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:12px;">View Portfolio ‚Üí</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== Initialization & Event Listeners =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Initializing NYC CRE Explorer...');

      // 1. Initialize Map
      try {
        state.map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/dark-v11',
          center: [-73.985, 40.748], // Manhattan (Empire State Bldg)
          zoom: 13,
          pitch: 45
        });

        state.map.addControl(new mapboxgl.NavigationControl());

        state.map.on('load', () => {
          console.log('Map loaded');
          
          // Heatmap Source & Layer
          state.map.addSource('heatmap-source', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
          });
          
          state.map.addLayer({
            id: 'heatmap-layer',
            type: 'heatmap',
            source: 'heatmap-source',
            maxzoom: 15,
            paint: {
              'heatmap-weight': ['get', 'weight'],
              'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1, 15, 3],
              'heatmap-color': [
                'interpolate', ['linear'], ['heatmap-density'],
                0, 'rgba(0,0,0,0)',
                0.2, '#22c55e',
                0.6, '#eab308',
                1, '#ef4444'
              ],
              'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 0, 2, 15, 20],
              'heatmap-opacity': 0.7
            },
            layout: { visibility: 'none' }
          });
          
          // Initial Data Fetch
          fetchData();
        });
      } catch (err) {
        console.error('Map initialization error:', err);
        // Fallback if map fails (e.g. token issue)
        fetchData();
      }

      // 2. Initialize Auth
      auth.init();

      // 3. Setup UI Event Listeners
      setupPagination();

      // Building Class Filters
      document.querySelectorAll('.filter-btn[data-class]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // Update UI
          document.querySelectorAll('.filter-btn[data-class]').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          // Update State
          state.filters.bldgclass = e.target.dataset.class;
          state.page = 1;
          
          fetchData();
        });
      });

      // FAR Gap Filter
      const farFilter = document.getElementById('farFilter');
      if (farFilter) {
        farFilter.addEventListener('change', (e) => {
          state.filters.minFarGap = e.target.value;
          state.page = 1;
          fetchData();
        });
      }

      // Distress Filter
      const distressFilter = document.getElementById('distressFilter');
      if (distressFilter) {
        distressFilter.addEventListener('change', (e) => {
          state.filters.minDistress = e.target.value;
          state.page = 1;
          fetchData();
        });
      }

      // Mobile/Layout Resizing
      window.addEventListener('resize', () => {
        if (state.map) state.map.resize();
      });
    });
  </script>
</body>
</html>
